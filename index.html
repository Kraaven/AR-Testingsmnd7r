<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR.js with Three.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <script>
        let scene, camera, renderer, arToolkitSource, arToolkitContext;

        function init() {
            scene = new THREE.Scene();

            camera = new THREE.Camera();
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });

            arToolkitSource.init(function onReady() {
                onResize();
            });

            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
                detectionMode: 'mono',
            });

            arToolkitContext.init(function onCompleted() {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });

            let markerRoot = new THREE.Group();
            scene.add(markerRoot);
            let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                type: 'pattern',
                patternUrl: "assets/marker.patt",
            });

            // Load 3D model
            new THREE.GLTFLoader().load(
                'assets/asset.glb',
                function (gltf) {
                    let model = gltf.scene;
                    model.scale.set(0.9, 0.9, 0.9);
                    markerRoot.add(model);

                    // Add animation
                    let mixer = new THREE.AnimationMixer(model);
                    gltf.animations.forEach((clip) => {
                        mixer.clipAction(clip).play();
                    });

                    function animateModel() {
                        requestAnimationFrame(animateModel);
                        if (mixer) mixer.update(0.01);
                    }
                    animateModel();
                },
                function (xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function (error) {
                    console.error('An error happened', error);
                }
            );

            // Add lights
            let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
            scene.add(ambientLight);

            let pointLight = new THREE.PointLight(0xffffff, 0.5);
            camera.add(pointLight);
        }

        function onResize() {
            arToolkitSource.onResizeElement();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
            if (arToolkitContext.arController !== null) {
                arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (arToolkitSource.ready !== false) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', function () {
            onResize();
        });

        init();
        animate();
    </script>
</body>
</html>
